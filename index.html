<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lingo Path — Immersive Lessons + Translator (v4)</title>
<style>
  :root{
    --bg:#0e1016; --panel:#131826; --ink:#eaf0ff; --muted:#a4b2cc; --line:#20283a;
    --brand:#7dd3fc; --brand2:#34d399; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
  }
  [data-theme="light"]{
    --bg:#f7fbff; --panel:#ffffff; --ink:#0f172a; --muted:#46566f; --line:#dfe7f3;
    --brand:#0284c7; --brand2:#059669; --danger:#dc2626; --ok:#059669; --warn:#b45309;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(180deg, var(--bg), #0a0d14 55%); color:var(--ink);
    font:16px/1.5 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    display:flex; flex-direction:column;
  }
  header{position:sticky; top:0; z-index:50; backdrop-filter: blur(10px); background:color-mix(in oklab, var(--bg) 85%, transparent); border-bottom:1px solid var(--line);}
  .bar{max-width:1200px; margin:auto; padding:.8rem 1rem; display:flex; gap:.8rem; align-items:center;}
  .brand{font-weight:900; letter-spacing:.3px}
  .spacer{flex:1}
  .btn{cursor:pointer; padding:.6rem .8rem; border-radius:.7rem; border:1px solid var(--line); background:var(--panel); color:var(--ink);}
  .btn.primary{border:0; background:linear-gradient(135deg, var(--brand), var(--brand2)); color:#06222a; font-weight:800}
  .tabs{display:flex; gap:.4rem; flex-wrap:wrap}
  .tab{padding:.45rem .7rem; border-radius:.6rem; border:1px solid var(--line); cursor:pointer}
  .tab.active{background:var(--brand); color:#06222a; border:0; font-weight:800}
  main{max-width:1200px; width:100%; margin:1rem auto; padding:0 1rem; display:grid; gap:1rem}
  section.panel{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:1rem}
  h2{margin:.3rem 0 1rem 0}
  .muted{color:var(--muted)}
  .row{display:flex; gap:.6rem; align-items:center; flex-wrap:wrap}
  .grid{display:grid; gap:1rem}
  @media(min-width:900px){ .grid-2{grid-template-columns:1.2fr .8fr} .grid-3{grid-template-columns:repeat(3,1fr)}}
  .lesson-card{display:flex; flex-direction:column; gap:.6rem; padding:1rem; border:1px dashed var(--line); border-radius:12px}
  .lesson-card.locked{opacity:.6; filter:grayscale(1)}
  .progress{height:8px; border-radius:6px; background:color-mix(in oklab, var(--ink) 12%, transparent); overflow:hidden}
  .progress>span{display:block; height:100%; background:linear-gradient(90deg, var(--brand), var(--brand2)); width:0}
  .pill{display:inline-flex; gap:.4rem; align-items:center; padding:.2rem .55rem; border-radius:.6rem;
        background:color-mix(in oklab, var(--ink) 10%, transparent); color:var(--ink); border:1px solid var(--line)}
  .choice-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:.7rem}
  .choice{border:1px solid var(--line); border-radius:12px; padding:1rem; text-align:center; cursor:pointer; background:#0f1420}
  body[data-theme="light"] .choice{background:#f6faff}
  .choice.correct{outline:2px solid var(--ok)}
  .choice.wrong{outline:2px solid var(--danger)}
  .big{font-size:1.9rem; font-weight:800}
  .center{display:flex; align-items:center; justify-content:center}
  .hearts{display:flex; gap:.25rem}
  .heart{font-size:1.3rem}
  .result{display:flex; flex-direction:column; gap:.8rem; align-items:center; padding:1rem; border:1px dashed var(--line); border-radius:12px}
  footer{padding:1rem; text-align:center; color:var(--muted); font-size:.9rem}
</style>
</head>
<body data-theme="dark">
<header>
  <div class="bar">
    <div class="brand">🟨 Lingo Path</div>
    <nav class="tabs" id="tabs"></nav>
    <div class="spacer"></div>
    <span class="muted">v4</span>
    <button class="btn" id="toggleTheme">🌓</button>
    <button class="btn" id="resetBtn">Reset</button>
  </div>
</header>
<main>
  <section class="panel" id="home"><h2>Welcome 👋</h2>
    <div class="row"><span class="pill">Course: <strong id="courseName"></strong></span>
      <span class="pill">XP: <strong id="xp"></strong></span>
      <span class="pill">Streak: <strong id="streak"></strong>d</span></div>
    <div class="row"><button class="btn" id="placement">Placement</button>
      <button class="btn" id="review">Review</button></div>
  </section>
  <section class="panel hidden" id="course"><h2>Course Map</h2><div id="units" class="grid grid-3"></div></section>
  <section class="panel hidden" id="player">
    <div class="row" style="justify-content:space-between"><div><span class="pill" id="lessonTitle"></span><span class="pill" id="taskIdx"></span><span id="hearts"></span></div>
      <div><button class="btn" id="speakBtn">🔊</button><button class="btn" id="micBtn">🎙️</button><span class="pill">XP <strong id="xpMini"></strong></span></div></div>
    <div id="taskArea"></div><div class="row"><div class="progress" style="flex:1"><span id="progressBar"></span></div><button class="btn primary" id="nextBtn">Next</button><div id="feedback"></div></div>
  </section>
  <section class="panel hidden" id="translate"><h2>Translate</h2><textarea id="ltInput"></textarea><button class="btn" id="ltRun">Translate</button><textarea id="ltOutput"></textarea><div id="ltStatus"></div></section>
</main>
<footer>If you still see 2 lessons, click Reset + refresh.</footer>
<script>
/* ---------------- Course Generator (50 lessons) ---------------- */
function chunk(a,n){let o=[];for(let i=0;i<a.length;i+=n)o.push(a.slice(i,i+n));return o}
function shuffle(a){for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function pick(a,n){return shuffle([...a]).slice(0,n)}
const BANK={u1:{title:"Unit 1 — Greetings",img:[["👋","hello"],["🌞","good morning"],["🌙","good night"],["🙏","thank you"],["🙇","please"]],phrases:[["Hello","Hola"],["Thank you","Gracias"]],arrange:[["I am Anna","Yo soy Anna"]]},u2:{title:"Unit 2 — Food",img:[["🍎","apple"],["🍞","bread"],["☕","coffee"],["💧","water"]],phrases:[["I like coffee","Me gusta el café"],["Water, please","Agua, por favor"]],arrange:[["I eat bread","Yo como pan"]]}};
function buildUnit(uid,b){const lessons=[];for(let i=0;i<10;i++){const [pL2,pL1]=b.phrases[0];lessons.push({id:`${uid}l${i+1}`,title:`${b.title} ${i+1}`,tasks:[{type:"image-mc",promptL2:b.img[0][1],options:b.img.map(([l,v])=>({label:l,value:v,correct:v===b.img[0][1]}))},{type:"phrase-mc",promptL2:pL2,promptL1:pL1,options:[pL2,"Other"],correct:pL2}]})}return lessons}
function buildCourse(){return{id:"en-es",name:"English (for Spanish)",units:Object.entries(BANK).map(([id,b])=>({id,title:b.title,lessons:buildUnit(id,b)}))}}
const DEFAULT_COURSE=buildCourse();
/* ---------------- Storage & Self-heal ---------------- */
const store={key:"lp",load:()=>JSON.parse(localStorage.getItem("lp")||"null"),save:d=>localStorage.setItem("lp",JSON.stringify(d))};
let db=store.load()||{course:DEFAULT_COURSE,progress:{xp:0,streak:[],lessonStats:{}}};
if(!db.course.units||db.course.units.length<2){db.course=DEFAULT_COURSE;db.progress={xp:0,streak:[],lessonStats:{}};store.save(db)}
/* ---------------- Render Course ---------------- */
function renderCourse(){const wrap=document.getElementById("units");wrap.innerHTML="";db.course.units.forEach(u=>{const col=document.createElement("div");col.innerHTML=`<h3>${u.title}</h3>`;u.lessons.forEach(l=>{const b=document.createElement("button");b.className="btn";b.textContent=l.title;b.onclick=()=>startLesson(u.id,l);col.appendChild(b)});wrap.appendChild(col)})}
function renderHome(){document.getElementById("courseName").textContent=db.course.name;document.getElementById("xp").textContent=db.progress.xp}
/* ---------------- Lesson Engine ---------------- */
let session=null;function startLesson(uid,lesson){session={unitId:uid,lesson,i:0,xp:0,queue:lesson.tasks};show("player");renderTask()}
function renderTask(){const t=session.queue[session.i];document.getElementById("lessonTitle").textContent=session.lesson.title;document.getElementById("taskIdx").textContent=`${session.i+1}/${session.queue.length}`;const area=document.getElementById("taskArea");area.innerHTML="";if(t.type==="image-mc"){area.innerHTML=`<div>${t.promptL2}</div>`+t.options.map((o,i)=>`<button class="choice" data-i=${i}>${o.label}</button>`).join("");area.querySelectorAll(".choice").forEach(btn=>btn.onclick=()=>finalize(t.options[btn.dataset.i].correct))}if(t.type==="phrase-mc"){area.innerHTML=`<div>${t.promptL2}</div>`+t.options.map((o,i)=>`<button class="choice" data-i=${i}>${o}</button>`).join("");area.querySelectorAll(".choice").forEach(btn=>btn.onclick=()=>finalize(btn.textContent===t.correct))}}
function finalize(ok){if(ok)session.xp+=10;session.i++;if(session.i>=session.queue.length){db.progress.xp+=session.xp;store.save(db);document.getElementById("taskArea").innerHTML=`<h3>Lesson done! XP+${session.xp}</h3>`}else renderTask()}
/* ---------------- Tabs ---------------- */
function show(id){document.querySelectorAll("section.panel").forEach(s=>s.classList.toggle("hidden",s.id!==id))}
document.getElementById("placement").onclick=()=>startLesson("u1",db.course.units[0].lessons[0])
document.getElementById("review").onclick=()=>startLesson("u1",{id:"r",title:"Review",tasks:db.course.units[0].lessons[0].tasks})
/* ---------------- Mic (robust) ---------------- */
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;let rec=null;
async function ensureMicPermission(){if(!navigator.mediaDevices?.getUserMedia)return;const s=await navigator.mediaDevices.getUserMedia({audio:true});s.getTracks().forEach(t=>t.stop())}
function startRecognition(){if(!SR){alert("No SpeechRecognition support");return}if(!rec){rec=new SR();rec.lang="en-US";rec.interimResults=false;rec.maxAlternatives=1}
rec.onresult=e=>{const heard=e.results[0][0].transcript;document.getElementById("feedback").textContent="Heard: "+heard};
rec.onerror=e=>{document.getElementById("feedback").textContent="Mic error: "+e.error};
ensureMicPermission().then(()=>{try{rec.start()}catch(e){}})}
document.getElementById("micBtn").onclick=startRecognition;
/* ---------------- Translate (LibreTranslate) ---------------- */
const LT_ENDPOINT="https://translate.astian.org";async function ltTranslate(q){const r=await fetch(`${LT_ENDPOINT}/translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({q,source:"auto",target:"es"})});return(await r.json()).translatedText}
document.getElementById("ltRun").onclick=async()=>{document.getElementById("ltOutput").value=await ltTranslate(document.getElementById("ltInput").value)}
/* ---------------- Init ---------------- */
function init(){renderTabs();renderHome();renderCourse()}
function renderTabs(){const tabs=[["home","Home"],["course","Course"],["player","Lesson"],["translate","Translate"]];const nav=document.getElementById("tabs");nav.innerHTML="";tabs.forEach(([id,l],i)=>{const b=document.createElement("button");b.textContent=l;b.className="tab"+(i===0?" active":"");b.onclick=()=>{show(id);document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));b.classList.add("active")};nav.appendChild(b)})}
init();
/* ---------------- Service Worker ---------------- */
if('serviceWorker' in navigator){const sw=`const C='lp-v5';self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(['./'])));self.skipWaiting()});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(k=>Promise.all(k.filter(x=>x!==C).map(x=>caches.delete(x)))))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))})`;const u=URL.createObjectURL(new Blob([sw],{type:"text/javascript"}));navigator.serviceWorker.register(u)}}
</script>
</body>
</html>